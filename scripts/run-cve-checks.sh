#!/bin/sh
#
# CIP Core, generic profile
#
# Copyright (c) Toshiba Corp., 2020
#
# Authors:
#  Daniel Sangorrin <daniel.sangorrin@toshiba.co.jp>
#
# SPDX-License-Identifier: MIT
#

# This script is used in .gitlab-ci.yml to create
# CVE reports in CSV format for each build target.
# It uses the dpkg status files generated during
# the build stages and saved as gitlab-ci artifacts.

set -e

# Install AWS CLI
if ! which aws 2>&1 >/dev/null; then
	echo "Installing awscli..."
	pip3 install wheel
	pip3 install awscli
fi

# Create new CVE reports
mkdir cve-reports
RELEASES="buster bullseye"
for RELEASE in $RELEASES; do
   # Retrieve the latest dpkg status files from AWS
   aws s3 cp --no-progress --recursive s3://download.cip-project.org/cip-core/cve-checks/dpkg-status/$RELEASE/ ./
   for i in *.dpkg_status; do
      echo "Checking $i"
      filename=${i%.dpkg_status}
      cve-checker.py --suite $RELEASE --status $i --output ./cve-reports/$filename.csv
      # Create updated CVE report and announce in cip dev
      aws s3 cp --no-progress --recursive s3://download.cip-project.org/cip-core/cve-checks/cve-reports/$filename.csv ./
      announce_updated_cve.py -b ./$filename.csv -a ./cve-reports/$filename.csv -o updated-$filename.csv -s 10.23.53.61
      rm ./$filename.csv
      rm $i
   done
done

# Synchronize the CVE reports to AWS (it will delete old reports)
aws s3 sync --no-progress --delete --acl public-read cve-reports s3://download.cip-project.org/cip-core/cve-checks/cve-reports
