#!/bin/sh
#
# CIP Core, generic profile
#
# Copyright (c) Toshiba Corp., 2023
#
# Authors:
#  Daniel Sangorrin <daniel.sangorrin@...>
#
# SPDX-License-Identifier: MIT
#

# This script is used in .gitlab-ci.yml to create
# CVE reports in CSV format for each deployed build target.
# It uses the dpkg status files generated during the
# build stages and saved as gitlab-ci artifacts.

set -e

# Install AWS CLI
if ! which aws >/dev/null 2>&1; then
	echo "Installing awscli..."
	apt update
	apt install -y python3-wheel
	apt install -y awscli
fi

# Retrieve the latest dpkg status files from AWS
aws s3 cp --no-progress --recursive s3://download.cip-project.org/cip-core/cve-checks/dpkg-status/ ./

# Create new CVE reports
mkdir cve-reports
for file in *.dpkg_status; do
	echo "Checking $file"
	cve_checker.py --status "$file" --output ./cve-reports/"${file%.dpkg_status}".csv
done

# Synchronize the CVE reports to AWS (it will delete old reports)
aws s3 sync --no-progress --delete --acl public-read cve-reports s3://download.cip-project.org/cip-core/cve-checks/cve-reports
