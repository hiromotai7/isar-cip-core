#!/bin/sh
#
# CIP Core, generic profile
#
# Copyright (c) Siemens AG, 2023-2024
#
# Authors:
#  Quirin Gylstorff <quirin.gylstorff@siemens.com>
#
# SPDX-License-Identifier: MIT

open_tpm2_partition() {
	partition_device="$1"
	crypt_mount_name="$2"
	tpm_device="$3"
	if ! /usr/lib/systemd/systemd-cryptsetup attach "$crypt_mount_name" \
		 "$partition_device" - tpm2-device="$tpm_device"; then
		panic "Can't decrypt '$partition_device' !"
	fi
}

enroll_tpm2_token() {
	partition_device="$1"
	passphrase="$2"
	tpm_device="$3"
	#tpm_key_algorithm="$4"
	#pcr_bank_hash_type="$5"

	# check systemd version and export password if necessary
	if [ -x /usr/bin/systemd-cryptenroll ]; then
		systemd_version=$(systemd-cryptenroll --version | \
			  awk -F " " 'NR==1{print $2 }')
		# check systemd version and export password if necessary
		# systemd version 251 does not suport hash_types
		if [ "$systemd_version" -ge "251" ]; then
			PASSWORD=$(cat "$passphrase" )
			export PASSWORD
			/usr/bin/systemd-cryptenroll --tpm2-device="$tpm_device" \
				 --tpm2-pcrs=7 "$partition_device"
			PASSWORD=
		else
			panic "Unknown systemd version: '$systemd_version'!"
		fi
	else
		panic "systemd-cryptenroll not available cannot enroll tpm2 key!"
	fi
}

prepare_for_encryption() {
	true
}

finalize_tpm2_encryption() {
	partition_device="$1"
-	/usr/bin/systemd-cryptenroll --wipe-slot=0 "$partition_device"
}

