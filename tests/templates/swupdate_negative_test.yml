device_type: qemu
job_name: #architecture# software update testing
timeouts:
  job:
    minutes: 50
  action:
   minutes: 40
  actions:
    power-off:
      seconds: 60
tags:
- swtpm-jobs
priority: medium
visibility: public
notify:
  criteria:
    status: finished
  recipients:
  - to:
     method: email
     email: cip-testing-results@lists.cip-project.org

# ACTION BLOCK
actions:
- command:
    name: start_tpm
    timeout:
          minutes: 20

# DEPLOY BLOCK
- deploy:
    timeout:
      minutes: 10
    to: downloads
    images:
      image:
        url: #project_url#/#branch#/#architecture#/cip-core-image-security-cip-core-#distribution#-#architecture#.swu

- deploy:
    timeout:
      minutes: 30
    to: tmpfs
    images:
      system:
        image_arg: '-drive file={system},discard=unmap,if=none,id=disk,format=raw -m 1G -serial mon:stdio -smp 4
                    -nographic -netdev user,id=net,hostfwd=tcp:127.0.0.1:22222-:22 -chardev socket,id=chrtpm,path=/tmp/qemu-swtpm.sock
                    -tpmdev emulator,id=tpm0,chardev=chrtpm #imageargs#'
        url: #project_url#/#branch#/#architecture#/cip-core-image-security-cip-core-#distribution#-#architecture#.wic.xz
        compression: xz

      #Firmware#
        #Firmware_args#
        #Firmware_url#

# BOOT BLOCK
- boot:
    timeout:
      minutes: 25
    method: qemu
    media: tmpfs
    prompts: ["root@demo:~#"]
    auto_login:
      login_prompt: "demo login:"
      username: "root"
      password_prompt: "Password:"
      password: "CIPsecurity@123"

# TEST_BLOCK
# Fail the job if software update application error is not as expected
- test:  
    timeout:
      minutes: 25
    definitions:
    - repository:
        metadata:
          format: Lava-Test Test Definition 1.0
          name: sample-test
          description: "Test software update by modifying the files"
        run:
          steps:
            #TEST_BLOCK_STEPS#
      from: inline
      name: sample-test-1
      path: inline/sample-test.yaml

context:
  arch: #context-architecture#
  guestfs_interface: virtio
  lava_test_results_dir: '/home/lava-%s'
