device_type: qemu
job_name: #architecture# software update testing
timeouts:
  job:
    minutes: 50
  action:
   minutes: 40
  actions:
    power-off:
      seconds: 60
tags:
- swtpm-jobs
priority: medium
visibility: public
notify:
  criteria:
    status: finished
  recipients:
  - to:
     method: email
     email: cip-testing-results@lists.cip-project.org

# ACTION BLOCK
actions:
- command:
    name: start_tpm
    timeout:
          minutes: 20

# DEPLOY BLOCK
- deploy:
    timeout:
      minutes: 30
    to: tmpfs
    images:
      system:
        image_arg: '-drive file={system},discard=unmap,if=none,id=disk,format=raw -m 1G -serial mon:stdio -smp 4
                    -nographic -netdev user,id=net,hostfwd=tcp:127.0.0.1:22222-:22 -chardev socket,id=chrtpm,path=/tmp/qemu-swtpm.sock
                    -tpmdev emulator,id=tpm0,chardev=chrtpm #imageargs#'
        url: #project_url#/#branch#/#architecture#/cip-core-image-security-cip-core-#distribution#-#architecture#.wic.xz
        compression: xz

      #Firmware#
        #Firmware_args#
        #Firmware_url#

# BOOT BLOCK
- boot:
    timeout:
      minutes: 25
    method: qemu
    media: tmpfs
    prompts: ["root@demo:~#"]
    auto_login:
      login_prompt: "demo login:"
      username: "root"
      password_prompt: "Password:"
      password: "CIPsecurity@123"

# TEST_BLOCK
# Fail the job if software update application failed
- test:
    timeout:
      minutes: 15
    definitions:
    - repository:
        metadata:
          format: Lava-Test Test Definition 1.0
          name: sample-test
          description: "Test software update"
        run:
          steps:
            - if swupdate -d "-u #project_url#/#branch#/#architecture#/cip-core-image-security-cip-core-#distribution#-#architecture#.swu"; then echo software update is successful!!; else lava-test-raise "Fail job"; fi
      from: inline
      name: sample-test-1
      path: inline/sample-test.yaml

# qemu-swtpm.sock will be gone after soft reboot.
# So the swtpm socket need to be started again for proper reboot
# To start the swtpm daemon, first the existing one should be killed
- command:
    name: manual_kill
    timeout:
          minutes: 1
# Start the swtpm daemon
- command:
    name: start_tpm
    timeout:
          minutes: 1

- boot:
    timeout:
      minutes: 5
    method: qemu
    media: tmpfs
    prompts: ["root@demo:~#"]
    auto_login:
      login_prompt: "demo login:"
      username: "root"
      password_prompt: "Password:"
      password: "CIPsecurity@123"
    parameters:
       kernel-start-message: "kernel: C:BOOT1:linux.efi"

# Fail the job if ustate is not #updatestate# after reboot
- test:
    timeout:
      minutes: 5
    definitions:
    - repository:
        metadata:
          format: Lava-Test Test Definition 1.0
          name: sample-test
          description: "check boot loader environment variables"
        run:
          steps:
            - if [ $(bg_printenv | grep ustate | awk 'FNR == 2{print $2}') = 2 ]; then bg_setenv -c; else lava-test-raise "Fail job"; fi
      from: inline
      name: sample-test-2
      path: inline/sample-test.yaml

context:
  arch: #context-architecture#
  guestfs_interface: virtio
  lava_test_results_dir: '/home/lava-%s'
