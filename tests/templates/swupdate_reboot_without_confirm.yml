# qemu-swtpm.sock will be gone after soft reboot.
# So the swtpm socket need to be started again for proper reboot
# To start the swtpm daemon, first the existing one should be killed
- command:
    name: manual_kill
    timeout:
          minutes: 1
# Start the swtpm daemon
- command:
    name: start_tpm
    timeout:
          minutes: 1

- boot:
    timeout:
      minutes: 5
    method: qemu
    media: tmpfs
    prompts: ["root@demo:~#"]
    auto_login:
      login_prompt: "demo login:"
      username: "root"
      password_prompt: "Password:"
      password: "CIPsecurity@123"
    parameters:
       kernel-start-message: "kernel: C:BOOT0:linux.efi" 

# Fail the job if ustate is not 3 (failed) after reboot
- test:
    timeout:
      minutes: 5
    definitions:
    - repository:
        metadata:
          format: Lava-Test Test Definition 1.0
          name: sample-test
          description: "check boot loader environment variables"
        run:
          steps:
            - if [ $(bg_printenv | grep ustate | awk 'FNR == 2{print $2}') = 3 ]; then echo ustate status failed; else lava-test-raise "Fail job"; fi
      from: inline
      name: sample-test-3
      path: inline/sample-test.yaml
